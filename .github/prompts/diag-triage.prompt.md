# Diagnostic Prompt — Issue Triage

## Context

This prompt is used to triage issues reported by users of the homebridge-eufy-security plugin. Diagnostics are collected via the plugin UI and contain log files and a device snapshot.

**Important**: This plugin (`homebridge-eufy-security`) relies heavily on the underlying `eufy-security-client` library (by bropat). During triage, narrow down ASAP whether the issue originates in `homebridge-eufy-security` (accessory registration, HomeKit mapping, service pruning, config handling) or in `eufy-security-client` (device discovery, property events, push notifications, P2P connections, API communication).

## Diagnostics Archive Structure

A complete diagnostics folder contains:

```
diagnostics-YYYY-MM-DD-HH-MM-SS/
  accessories.json       — device tree snapshot generated by the UI
  configui-server.log    — plugin UI server log
  configui-lib.log       — eufy-security-client library log used by the UI
  eufy-security.log      — plugin runtime log
  eufy-lib.log           — eufy-security-client library log
  ffmpeg.log             — FFmpeg transcoding log (optional)
```

There are two categories of logs depending on the area of the issue:

### Plugin WebUI (UI-related issues)
- `accessories.json`, `configui-server.log`, `configui-lib.log`

### Plugin Runtime (Homebridge runtime issues)
- `accessories.json`, `eufy-security.log`, `eufy-lib.log`

### Optional
- `ffmpeg.log` — only relevant for streaming/snapshot issues

## Safeguard — Incomplete Diagnostics

Before any analysis, check which files are present:

- **If runtime logs (`eufy-security.log`, `eufy-lib.log`) are missing**: the plugin was not running when diagnostics were exported. Stop analysis — reply to the user asking to restart Homebridge, wait for the plugin to fully load, then re-export diagnostics.
- **If UI logs (`configui-server.log`, `configui-lib.log`) are missing**: the UI server wasn't active. These are only needed for UI-related issues.
- **If only `accessories.json` is present**: the archive is incomplete. Only device presence can be confirmed, not runtime behavior.

Do **not** attempt further analysis without the relevant logs for the reported issue area.

## Diagnostic Steps

### 1. Validate archive completeness (see safeguard above)

### 2. Check if debug mode is enabled

In `eufy-security.log`, check the first few lines for indicators:
- **Debug enabled**: log level shows `DEBUG`, template includes file/line references (e.g. `platform.ts:311`), logger name contains the version (e.g. `[EufySecurity-4.4.2-beta.41]`)
- **Debug disabled**: log level starts at `INFO`, no file/line references, logger name is just `[EufySecurity]`

You can also confirm from the config dump in the log: `"enableDetailedLogging":true` or `false`.

**If debug is disabled**, the logs will lack critical details (no `DEBUG` entries for device discovery, characteristic registration, property changes). Ask the user to enable `Detailed Logging` in the plugin settings and re-export diagnostics.

### 3. Extract environment info

From the first lines of `eufy-security.log`, extract:
- Plugin version (e.g. `4.4.2-beta.41`)
- eufy-security-client library version
- OS and architecture
- Storage path

**If the environment indicates HOOBS** (storage path, OS details, or user mentions it): label `hoobs` + `wontfix` and close the issue. The Plugin UI is known to not work properly on HOOBS and we do not support it. Comment on the issue:

```
Thank you @<username> for reporting this.

Unfortunately, HOOBS is not supported. The Plugin UI is known to not work properly on HOOBS and we are unable to provide support for it.

I recommend migrating to Homebridge for the best experience with this plugin.
```

### 4. Check config for excluded devices

From the config dump in `eufy-security.log`, check:
- `ignoreDevices` — array of serials explicitly excluded
- `ignoreStations` — array of station serials excluded
- `cleanCache` — if true, stale accessories are pruned on restart

Also in `accessories.json`, check:
- `disabled: true` on a station — prevents its devices from loading
- `ignored: true` on a device — device is excluded
- `unsupported: true` — device type not supported by the plugin

### 5. Confirm device presence

In `accessories.json`, search for the reported device by type, model, serial, or name. Note key properties: `type`, `isCamera`, `isSmartDrop`, `isLock`, `isDoorbell`, `DeviceEnabled`, `disabled`, `ignored`, `unsupported`, `standalone`.

### 6. Analyze logs based on issue area

#### For runtime issues — check `eufy-security.log`:
- Device discovery: search for device name/serial, `register_device`, `isSmartDrop`, `isCamera`, `isLock`, etc.
- Discovery warnings: `[DISCOVERY WARNING]`, `[DEVICE SKIP]`, `[STATION SKIP]`
- Accessory instantiation: `Constructed`, `REGISTER CHARACTERISTIC`, `SEED`
- Service pruning: `Pruning unused service`
- Property events: `Property Changes`, `ON '...`
- Errors: `Error`, `error`, stack traces

#### For runtime issues — check `eufy-lib.log`:
- Device serial presence — confirm the library loaded it
- `property changed` events for the relevant properties
- Connection/authentication errors
- Push notification handling

**Scope determination**: If the device doesn't appear in `eufy-lib.log` or fails at the library level (API errors, P2P failures, missing property events), the issue is likely in `eufy-security-client`. If the device loads in the library but fails during accessory registration, HomeKit mapping, or service pruning, the issue is in `homebridge-eufy-security`.

#### For UI issues — check `configui-server.log` and `configui-lib.log`:
- Login/authentication flow
- Device listing errors
- API request/response issues

### 7. Cross-reference with code

Key source files:
- `src/platform.ts` (`register_device`) — device registration logic, note that devices can stack multiple capabilities (independent `if` blocks, not `else if`)
- `src/accessories/BaseAccessory.ts` — characteristic registration, service pruning
- `src/accessories/Device.ts` — sensor/battery service, property helpers
- `src/accessories/<Type>Accessory.ts` — device-specific HomeKit mapping
- `homebridge-ui/server.js` — UI server logic, diagnostics generation

## Label Recommendations

Based on triage findings, suggest one or more labels for the issue:

| Label | When to use |
|---|---|
| `bug` | Something isn't working in the plugin |
| `depends on eufy-security-client` | Issue originates in bropat's eufy-security-client library |
| `device-support` | New device type support — requires both homebridge and/or upstream eufy-security-client changes |
| `debug log missing` | Diagnostics lack logs or debug mode was disabled |
| `configuration issue` | Problem caused by user config (ignored devices, wrong settings) |
| `livestream` | Camera livestream, video feed, P2P, RTSP, streaming failures |
| `enhancement` | New feature or improvement request |
| `question` | Further information is requested |
| `resolved in beta` | Fix or feature already in current beta, will ship in next release |
| `needs triage` | New issue awaiting initial analysis |
| `duplicate` | Issue or PR already exists |
| `invalid` | Issue doesn't seem right or not reproducible |
| `wontfix` | Will not be worked on |
| `documentation` | Documentation improvements |
| `dependencies` | Dependency updates |
| `hoobs` | HOOBS-specific issues — HOOBS is an alternative to Homebridge where the Plugin UI is known to not work properly. Label as `hoobs` + `wontfix` and close the issue. |
| `stale` | Inactive issue |
